<%# Read the number of drones from an environment variable, defaulting to 3 %>
<% num_drones = ENV.fetch('NUM_DRONES', 3).to_i %>

name: simulation_tmuxinator

windows:
  - gz_sim:
      layout: even-horizontal
      panes:
        - >
          GZ_SIM_RESOURCE_PATH=$GZ_SIM_RESOURCE_PATH:/git/PX4-Autopilot/Tools/simulation/gz/models:/git/PX4-Autopilot/Tools/simulation/gz/worlds
          gz sim -v4 -r default.sdf
        - "ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"

  <%# --- Dynamically Generated PX4 Windows --- %>
  <%# Loop 'num_drones' times to create a window for each drone %>
  <% num_drones.times do |i| %>
  - px4_sitl_<%= i + 1 %>: <%# Create a unique window name like px4_sitl_1 %>
      layout: even-horizontal
      panes:
        - >
          sleep <%= (i + 1) * 3 %> &&
          PX4_GZ_MODEL_POSE="<%= i * 2 %>,<%= i * 2 %>,0,0,0,0"
          PX4_SYS_AUTOSTART=4001
          PX4_UXRCE_DDS_NS="Drone<%= i + 1 %>"
          PX4_UXRCE_DDS_PORT=<%= 8888 + i %>
          /git/PX4-Autopilot/build/px4_sitl_default/bin/px4 -i <%= i + 1 %>
  <% end %>

  - housekeeping:
      layout: even-horizontal
      panes:
        - htop
        - "ip a && ss -tuln && echo $ROS_DISTRO && echo $ROS_DOMAIN_ID"
        - "gosu qgcuser /squashfs-root/AppRun"