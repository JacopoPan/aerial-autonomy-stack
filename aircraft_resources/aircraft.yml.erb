<% drone_type = ENV.fetch('DRONE_TYPE', 'quad') %>
<% autopilot = ENV.fetch('AUTOPILOT', 'px4') %>
<% drone_id = ENV.fetch('DRONE_ID', 1).to_i %>
<% headless = ENV.fetch('HEADLESS', 'false') %>

name: aircraft_tmuxinator

windows:

  - debug:
      layout: even-horizontal
      panes:
        - clear && echo "So nice to have you with us, this is the aircraft <%= drone_id %> container."

  <% if autopilot == 'px4' %>
  - uxrce_dds_aircraft_<%= drone_id %>:
      layout: even-horizontal
      panes:
        - MicroXRCEAgent udp4 -p 8888

  <% elsif autopilot == 'ardupilot' %>
  - mavsdk_aircraft_<%= drone_id %>:
      layout: even-horizontal
      panes:
        - /git/MAVSDK/build/src/mavsdk_server/src/mavsdk_server udpin://0.0.0.0:14550
  <% end %>

  - yolo:
      layout: even-horizontal
      panes:
        - python3 /git/aircraft_resources/yolo/yolo-inference.py <% if headless == 'true' %> --headless<% end %>

  - kiss-icp:
      layout: even-horizontal
      panes:
        - ros2 launch kiss_icp odometry.launch.py topic:=/lidar_points <% if headless == 'true' %> visualize:=false<% end %>

  - zenoh:
      layout: even-horizontal
      panes:
        - zenoh-bridge-ros2dds -e tcp/42.42.1.99:7447 -c /git/aircraft_resources/comms/zenoh_config_air.json5

  - serial_over_tcp:
      layout: even-horizontal
      panes:
        - >
          socat PTY,link=/dev/tty_drone_mcat,raw,echo=0,wait-slave TCP:42.42.1.99:54321 & 
          sleep <%= 3 + drone_id %> &&
          while true; do
            echo 'message from aircraft <%= drone_id %>' > /dev/tty_drone_mcat;
            sleep 2;
          done
        - sleep 2 && cat /dev/tty_drone_mcat
