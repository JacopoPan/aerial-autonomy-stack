<% drone_type = ENV.fetch('DRONE_TYPE', 'quad') %>
<% autopilot = ENV.fetch('AUTOPILOT', 'px4') %>
<% drone_id = ENV.fetch('DRONE_ID', 1).to_i %>
<% headless = ENV.fetch('HEADLESS', 'false') %>
<% camera = ENV.fetch('CAMERA', 'true') %>
<% lidar = ENV.fetch('LIDAR', 'true') %>

name: drone

windows:

  - debug:
      layout: even-horizontal
      panes:
        - clear && echo "So nice to have you with us, this is the aircraft <%= drone_id %> container."

  <% if autopilot == 'px4' %>
  - uxrce_dds_aircraft_<%= drone_id %>:
      layout: even-horizontal
      panes:
        - MicroXRCEAgent udp4 -p 8888

  <% elsif autopilot == 'ardupilot' %>
  - mavros_aircraft_<%= drone_id %>:
      layout: even-horizontal
      panes:
        - ros2 launch mavros apm.launch fcu_url:=udp://0.0.0.0:<%= 22530 + drone_id - 1 %>@<%= 22530 + drone_id - 1 %> tgt_system:=<%= drone_id %>
  <% end %>

  <% if camera == 'true' %>
  - yolo:
      layout: even-horizontal
      panes:
        - ros2 run yolo_inference yolo_inference <% if headless == 'true' %> --headless<% end %> --ros-args -p use_sim_time:=True
  <% end %>

  <% if lidar == 'true' %>
  - kiss-icp:
      layout: even-horizontal
      panes:
        - ros2 launch kiss_icp odometry.launch.py topic:=/lidar_points <% if headless == 'true' %> visualize:=false<% end %>
  <% end %>

  - state_sharing_over_zenoh:
      layout: even-horizontal
      panes:
        - ros2 launch state_sharing state_sharing_launch.py autopilot:=<%= autopilot %> drone_id:=<%= drone_id %> use_sim_time:=true
        - >
          erb /aircraft_resources/comms/zenoh_config_air.json5.erb > /aircraft_resources/comms/zenoh_config_air.json5 &&
          zenoh-bridge-ros2dds -e tcp/42.42.1.99:7447 -c /aircraft_resources/comms/zenoh_config_air.json5
