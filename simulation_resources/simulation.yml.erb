<% drone_type = ENV.fetch('DRONE_TYPE', 'quad') %>
<% autopilot = ENV.fetch('AUTOPILOT', 'px4') %>
<% num_drones = ENV.fetch('NUM_DRONES', 1).to_i %>
<% world = ENV.fetch('WORLD', 'impalpable_greyness') %>
<% headless = ENV.fetch('HEADLESS', 'false') %>

name: simulation_tmuxinator

windows:

  <% if autopilot == 'px4' %>
  - gz_sim:
      layout: even-horizontal
      panes:
        - >
          GZ_SIM_RESOURCE_PATH=$GZ_SIM_RESOURCE_PATH:/git/simulation_resources/aircraft_models:/git/simulation_resources/simulation_worlds 
          GZ_SIM_PHYSICS_ENGINE_PATH=$GZ_SIM_PHYSICS_ENGINE_PATH:/usr/lib/x86_64-linux-gnu/gz-physics-7/engine-plugins/
          gz sim -v4 -r <% if headless == 'true' %> -s <% end %> <%= world %>.sdf
  <% elsif autopilot == 'ardupilot' %>
  - gz_sim:
      layout: even-horizontal
      panes:
        - > 
          chmod +x /git/simulation_resources/aircraft_models/_create_ardupilot_models.sh &&
          /git/simulation_resources/aircraft_models/_create_ardupilot_models.sh <%= num_drones %> /git/simulation_resources/aircraft_models/<%= drone_type == 'quad' ? 'iris_with_ardupilot' : 'zephyr_with_ardupilot' %> &&
          chmod +x /git/simulation_resources/simulation_worlds/_create_ardupilot_world.sh &&
          /git/simulation_resources/simulation_worlds/_create_ardupilot_world.sh <%= num_drones %> <%= drone_type == 'quad' ? 'iris_with_ardupilot' : 'zephyr_with_ardupilot' %> /git/simulation_resources/simulation_worlds/<%= world %>.sdf &&
          GZ_SIM_SYSTEM_PLUGIN_PATH=/git/ardupilot_gazebo/build:$GZ_SIM_SYSTEM_PLUGIN_PATH 
          GZ_SIM_RESOURCE_PATH=/git/simulation_resources/aircraft_models:/git/simulation_resources/simulation_worlds:$GZ_SIM_RESOURCE_PATH 
          GZ_SIM_PHYSICS_ENGINE_PATH=$GZ_SIM_PHYSICS_ENGINE_PATH:/usr/lib/x86_64-linux-gnu/gz-physics-7/engine-plugins/
          gz sim -v4 -r <% if headless == 'true' %> -s <% end %> populated_ardupilot.sdf
  <% end %>

  <% num_drones.times do |i| %>
  <% if autopilot == 'px4' %>
  - px4_sitl_<%= i + 1 %>:
      layout: even-horizontal
      panes:
        - >
          sleep <%= (i + 1) * 3 %> &&
          PX4_GZ_MODEL_POSE="<%= i * 2 %>,<%= i * 2 %>,0,0,0,0"
          PX4_SYS_AUTOSTART=<%= drone_type == 'quad' ? '5140' : '5141' %>
          ROS_DOMAIN_ID=<%= i + 1 %>
          PX4_UXRCE_DDS_NS="Drone<%= i + 1 %>"
          PX4_UXRCE_DDS_AG_IP="42.42.1.<%= i + 1 %>"
          PX4_UXRCE_DDS_PORT=8888
          /git/PX4-Autopilot/build/px4_sitl_default/bin/px4 -i <%= i %>
        - "ROS_DOMAIN_ID=<%= i + 1 %> ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"
        - "ROS_DOMAIN_ID=<%= i + 1 %> ros2 run ros_gz_bridge parameter_bridge /world/<%= world %>/model/<%= drone_type == 'quad' ? 'x500' : 'standard_vtol' %>_<%= i %>/link/lidar/base_link/sensor/lidar3d/scan/points@sensor_msgs/msg/PointCloud2[gz.msgs.PointCloudPacked --ros-args -r /world/<%= world %>/model/<%= drone_type == 'quad' ? 'x500' : 'standard_vtol' %>_<%= i %>/link/lidar/base_link/sensor/lidar3d/scan/points:=/lidar_points"
        - >
          python3 /git/simulation_resources/comms/gz_to_gst_image_bridge.py 
          --gz_topic /world/<%= world %>/model/<%= drone_type == 'quad' ? 'x500' : 'standard_vtol' %>_<%= i %>/link/mono_cam/base_link/sensor/imager/image
          --ip 42.42.1.<%= i + 1 %> --port 5600
  <% elsif autopilot == 'ardupilot' %>
  - ardupilot_sitl_<%= i + 1 %>:
      layout: even-horizontal
      panes:
        - >
          sleep <%= (i + 1) * 3 %> &&
          /git/ardupilot/Tools/autotest/sim_vehicle.py 
          -v <%= drone_type == 'quad' ? 'ArduCopter' : 'ArduPlane' %> 
          -f <%= drone_type == 'quad' ? 'gazebo-iris' : 'gazebo-zephyr' %> 
          --model JSON
          -I <%= i %>
          -l $(awk -F "[><]" "/<spherical_coordinates>/,/<\/spherical_coordinates>/" /git/simulation_resources/simulation_worlds/<%= world %>.sdf | awk -F "[><]" "/latitude_deg/ {print \$3}"),$(awk -F "[><]" "/<spherical_coordinates>/,/<\/spherical_coordinates>/" /git/simulation_resources/simulation_worlds/<%= world %>.sdf | awk -F "[><]" "/longitude_deg/ {print \$3}"),$(awk -F "[><]" "/<spherical_coordinates>/,/<\/spherical_coordinates>/" /git/simulation_resources/simulation_worlds/<%= world %>.sdf | awk -F "[><]" "/elevation/ {print \$3}"),0          
          --out=udp:127.0.0.1:1455<%= i %>
          --out=udp:127.0.0.1:1454<%= i %>
          --out=udp:42.42.1.<%= i + 1 %>:14550
          --add-param-file=/git/simulation_resources/aircraft_models/<%= drone_type == 'quad' ? 'iris_with_ardupilot' : 'zephyr_with_ardupilot' %>_<%= i + 1 %>/ardupilot-4.6.params
        - "ROS_DOMAIN_ID=<%= i + 1 %> ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"
        - "ROS_DOMAIN_ID=<%= i + 1 %> ros2 run ros_gz_bridge parameter_bridge /world/<%= world %>/model/<%= drone_type == 'quad' ? 'iris_with_ardupilot' : 'zephyr_with_ardupilot' %>_<%= i + 1 %>/model/<%= drone_type == 'quad' ? 'iris' : 'zephyr' %>/link/lidar/base_link/sensor/lidar3d/scan/points@sensor_msgs/msg/PointCloud2[gz.msgs.PointCloudPacked --ros-args -r /world/<%= world %>/model/<%= drone_type == 'quad' ? 'iris_with_ardupilot' : 'zephyr_with_ardupilot' %>_<%= i + 1 %>/model/<%= drone_type == 'quad' ? 'iris' : 'zephyr' %>/link/lidar/base_link/sensor/lidar3d/scan/points:=/lidar_points"
        - >
          python3 /git/simulation_resources/comms/gz_to_gst_image_bridge.py 
          --gz_topic /world/<%= world %>/model/<%= drone_type == 'quad' ? 'iris_with_ardupilot' : 'zephyr_with_ardupilot' %>_<%= i + 1 %>/model/<%= drone_type == 'quad' ? 'iris' : 'zephyr' %>/link/mono_cam/base_link/sensor/imager/image
          --ip 42.42.1.<%= i + 1 %> --port 5600
  <% end %>
  <% end %>

  - tcp_repeater:
      layout: even-horizontal
      panes:
        - python3 /git/simulation_resources/comms/emulate_serial_over_tcp.py

  - ground_system:
      layout: even-horizontal
      panes:
        - "ros2 run ros_gz_bridge parameter_bridge /clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock"
        - sleep 3 && ros2 run ground_system oracle --num-drones <%=  num_drones %> --base-port 14540 --rate 10.0 --ros-args -p use_sim_time:=True

  - test:
      layout: even-horizontal
      panes:
        - ros2 run ground_system repeater --sub-domain 99 --pub-domain 1

  - debug:
      layout: even-horizontal
      panes:
        - # Interactive pane

  - qgc:
      layout: even-horizontal
      panes:
        <% if headless == 'true' %>
        - echo "Headless mode, not launching QGroundControl."
        <% else %>
        - gosu qgcuser /squashfs-root/AppRun -geometry 800x600+960+540
        <% end %>
